# Base: Ubuntu 20.04 com CUDA 12.2 Runtime
FROM nvidia/cuda:12.2.0-runtime-ubuntu20.04

# Evitar prompts ao instalar pacotes
ENV DEBIAN_FRONTEND=noninteractive

# Diretório de trabalho
WORKDIR /workspace/CrossKD

# Atualizar e instalar dependências básicas
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-dev \
    git \
    wget \
    curl \
    ca-certificates \
    build-essential \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copiar seu código
COPY crosskd/CrossKD /workspace/CrossKD
COPY mmdeploy /workspace/CrossKD/mmdeploy

# Instalar pip mais recente
RUN python3 -m pip install --upgrade pip

# Instalar dependências Python essenciais
RUN pip install --no-cache-dir \
    numpy \
    opencv-python-headless \
    pycocotools \
    onnxruntime-gpu==1.16.0 \
    mmcv-full \
    torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu122

# Instalar MMDeploy Runtime
RUN pip install --no-cache-dir /workspace/CrossKD/mmdeploy

# Variável para usar GPU
ENV CUDA_VISIBLE_DEVICES=0

# Comando padrão
CMD ["python3", "-u", "tools/custom_test.py"]
